<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <script src="/js/jszip.min.js"></script>
    <script src="/js/FileSaver.js"></script>
    <script src="/js/fabric.js"></script>
    <script src="/js/sprite.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <style>
        /* .prepared{
            width: 1920px;
            height: 1080px;

        } */
    </style>
    <canvas id="canvas" width="1024" height="720" style="border: 2px solid #000000">
        <!-- [[${json}]] -->
    </canvas>



    <div id="main">
        <input id="json1" class="canvasData" type="hidden" th:value='${list.get(0).getJson()}'>
        <input id="json2" class="canvasData" type="hidden" th:value='${list.get(1).getJson()}'>
        <input id="json3" class="canvasData" type="hidden" th:value='${list.get(2).getJson()}'>
        <input id="json4" class="canvasData" type="hidden" th:value='${list.get(3).getJson()}'>
        <input id="json5" class="canvasData" type="hidden" th:value='${list.get(4).getJson()}'>
        <input id="json6" class="canvasData" type="hidden" th:value='${list.get(5).getJson()}'>
        <input id="json7" class="canvasData" type="hidden" th:value='${list.get(6).getJson()}'>
        <input id="json8" class="canvasData" type="hidden" th:value='${list.get(7).getJson()}'>
        <input id="json9" class="canvasData" type="hidden" th:value='${list.get(8).getJson()}'>



        <button id="export">Export</button>
        <button id="prev">prev</button>
        <button id="next">next</button>
    </div>

    <div style="display: none;">
        <canvas id="preCan1" class="prepared"></canvas>
        <canvas id="preCan2" class="prepared"></canvas>
        <canvas id="preCan3" class="prepared"></canvas>
        <canvas id="preCan4" class="prepared"></canvas>
        <canvas id="preCan5" class="prepared"></canvas>
        <canvas id="preCan6" class="prepared"></canvas>
        <canvas id="preCan7" class="prepared"></canvas>
        <canvas id="preCan8" class="prepared"></canvas>
        <canvas id="preCan9" class="prepared"></canvas>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script>
        var canvas = new fabric.StaticCanvas('canvas');
        var preCanvas = document.getElementsByClassName("prepared");
        var preFCanvas = [];
        var canvasArr = document.getElementsByClassName("canvasData");
        var index = 1;

        for (let i = 0; i < preCanvas.length; i++) {
            let str = 'preCan' + (i + 1);
            // console.log(str);
            preFCanvas.push(new fabric.StaticCanvas(str, { width: 1920, height: 1080 }))
            preFCanvas[i].loadFromJSON(canvasArr[i].defaultValue)
        }
        canvas.loadFromJSON($('#json1').val());

        function zipFunc(callback) {
            console.log("zipFUNC")
            var fileName =[];
            var zip = new JSZip();
            var blobs = [];
            for (let i = 0; i < preFCanvas.length; i++) {
                fileName[i] =
                    function (i) {
                        return "albam" + i + ".png";
                    }(i)

            preFCanvas[i].getElement().toBlob(function (blob) {
                zip.file("albam" + i + ".png", new File([blob], "albam" + i + ".png", { type: "image/png", }));
            })
        }
        callback(zip);
        // return zip;
    }
    const cEvent = new CustomEvent('cus', {
        // bubbles: true,
        detail: {
            zips: zipFunc,
        }
    })

        window.addEventListener("cus", function(e){
            console.log("AAAAA");
            console.log(e);
            e.detail.zips(function(result){
                console.log("finish")
                console.log(result)
                result.generateAsync({type:"blob"})
                    .then(function(content){
                        console.log(content)
                        // saveAs(content,"asdasd.zip")
                    })
            })
            

        },false);


        document.getElementById('export').addEventListener("click", function (e) {

            setTimeout(function(){
                console.log("dispatch")
                window.dispatchEvent(cEvent);
            },2000);
            // document.getElementById('main').addEventListener("cus", function (e) {

            //     let det = e.detail;
            //     console.log(e.detail)

            //     det.zips.generateAsync({ type: "blob" })
            //         .then(function (content) {
            //             saveAs(content, "example.zip");
            //         });

            // })
            // this.dispatchEvent(cEvent);
        })

        // $('#export').click(function () {

        //     var zip = new JSZip();
        //     var arr = new Array();
        //     var fileName = [];


        //     for (let i = 0; i < canvasArr.length; i++) {
        //         fileName[i] =
        //             function (i) {
        //                 return "albam" + i + ".png";
        //             }(i)
        //         // canvas.loadFromJSON(canvasArr[i].defaultValue);
        //         preFCanvas[i].getElement().toBlob(function (blob) {
        //             arr.push(blob);
        //             if (arr.length === canvasArr.length) {
        //                 console.log(arr.length);
        //                 for (const i in arr) {
        //                     console.log(arr[i]);
        //                     zip.file(fileName[i], new File([arr[i]], fileName[i], { type: "image/png", }));
        //                 }
        //                 zip.generateAsync({ type: "blob" })
        //                     .then(function (content) {
        //                         saveAs(content, "example.zip");
        //                         fileName = null
        //                         arr = null
        //                     });
        //             }
        //         })
        //     }
        // });

        $("#prev").click(function () {
            var str = "#json" + index;
            canvas.loadFromJSON($(str).val());
            if (index > 0)
                index--;
            console.log(index);
        })
        $("#next").click(function () {
            var str = "#json" + index;
            canvas.loadFromJSON($(str).val());
            if (index < canvasArr.length)
                index++;
            console.log(index);
        })

    </script>

        var canvas = new fabric.Canvas('canvas');

        console.log(canvas);

        $('#readJSON').click(function () {
            var $json = $('#asd')
            var json = JSON.parse($json.val());
            // canvas.loadFromJSON($json.val());
            canvas.toJSON();
        })
    </script>

</body>

</html>